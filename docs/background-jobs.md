# Фоновые задачи (Background Jobs / Cron)

## Общая информация

Все фоновые задачи проекта находятся в файле `routes/console.php` и выполняются через Laravel Task Scheduler.

Для запуска планировщика необходимо добавить в crontab:
```bash
* * * * * cd /path-to-your-project && php artisan schedule:run >> /dev/null 2>&1
```

---

## Список фоновых задач

### 1. Обработка Live матчей

**Команда:** `live-matches:process`

**Расписание:** Каждую секунду

**Описание:** Обрабатывает live матчи в реальном времени.

**Файл:** `app/Console/Commands/ProcessLiveMatches.php`

**Особенности:**
- Выполняется в фоне (`runInBackground()`)
- Без перекрытия (`withoutOverlapping()`)

---

### 2. Обработка товарищеских матчей

**Команда:** `friendly-matches:process`

**Расписание:** Ежедневно в 00:00

**Описание:** 
- Обрабатывает запланированные товарищеские матчи на текущий день
- Генерирует результаты
- Назначает голы и ассисты
- Создает состав игроков
- Обновляет статистику пользователей
- Отправляет уведомления о завершении матчей

**Файл:** `app/Console/Commands/ProcessFriendlyMatches.php`

**Особенности:**
- Без перекрытия (`withoutOverlapping()`)

---

### 3. Отправка напоминаний о матчах

**Команда:** `notifications:send-game-reminders`

**Расписание:** Каждые 15 минут

**Описание:**
- Проверяет предстоящие матчи (товарищеские и турнирные)
- Отправляет уведомления за 24 часа до начала матча
- Отправляет уведомления за 1 час до начала матча
- Получает пользователей из команд-участников матча
- Использует `NotificationService` для отправки уведомлений

**Файл:** `app/Console/Commands/SendGameReminders.php`

**Особенности:**
- Без перекрытия (`withoutOverlapping()`)

---

### 4. Обработка запланированных уведомлений

**Команда:** `notifications:process-scheduled`

**Расписание:** Каждые 5 минут

**Описание:**
- Проверяет массовые уведомления с `scheduled_at <= now()`
- Отправляет их всем пользователям
- Обновляет статус уведомлений

**Файл:** `app/Console/Commands/ProcessScheduledNotifications.php`

**Особенности:**
- Без перекрытия (`withoutOverlapping()`)

---

## Структура команды

Все команды наследуются от `Illuminate\Console\Command` и должны содержать:

```php
protected $signature = 'command:name';
protected $description = 'Описание команды';

public function handle(): int
{
    // Логика команды
    return Command::SUCCESS; // или Command::FAILURE
}
```

---

## Мониторинг выполнения

Для мониторинга выполнения команд рекомендуется:

1. **Логирование:**
   ```php
   $this->info('Начало обработки');
   $this->error('Ошибка при обработке');
   $this->warn('Предупреждение');
   ```

2. **Логи Laravel:**
   Все команды автоматически логируются в `storage/logs/laravel.log`

3. **Метрики:**
   Можно добавить метрики времени выполнения, количества обработанных записей и т.д.

---

## Добавление новой фоновой задачи

1. Создайте команду:
   ```bash
   php artisan make:command YourCommandName
   ```

2. Реализуйте логику в методе `handle()`

3. Добавьте в `routes/console.php`:
   ```php
   Schedule::command('your:command')
       ->everyMinute() // или другой интервал
       ->withoutOverlapping()
       ->runInBackground(); // опционально
   ```

4. Обновите документацию (этот файл)

---

## Обработка ошибок

Все команды должны:
- Обрабатывать исключения
- Возвращать корректный код возврата (`Command::SUCCESS` или `Command::FAILURE`)
- Логировать ошибки
- Использовать транзакции для критичных операций

---

## Оптимизация производительности

1. **Batch processing:** Используйте `chunk()` для больших наборов данных
2. **Eager loading:** Загружайте связанные модели заранее
3. **Индексы БД:** Убедитесь, что запросы используют индексы
4. **Кеширование:** Кешируйте часто используемые данные
5. **Очереди:** Для тяжелых операций используйте очереди вместо синхронного выполнения

---

## Расписание задач

### Ежедневно (00:00)
- `friendly-matches:process` - Обработка товарищеских матчей

### Каждые 5 минут
- `notifications:process-scheduled` - Обработка запланированных уведомлений

### Каждые 15 минут
- `notifications:send-game-reminders` - Отправка напоминаний о матчах

### Каждую секунду
- `live-matches:process` - Обработка live матчей (в фоне)

---

## Зависимости между задачами

- `friendly-matches:process` запускается перед началом дня, чтобы обработать матчи
- `notifications:send-game-reminders` должен выполняться чаще, чтобы вовремя отправлять напоминания
- `notifications:process-scheduled` независим и может выполняться в любое время

---

## Тестирование задач

Для тестирования команд вручную:

```bash
# Выполнить команду один раз
php artisan friendly-matches:process

# С информацией о выполняемых задачах
php artisan schedule:run -v
```

