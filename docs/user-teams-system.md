# Система привязки игроков к командам

## Общая информация

Система отслеживает привязку игроков к командам по сезонам. Сезон определяется как календарный год (например, 2026).

---

## 1. Структура данных

### Таблица `user_teams`
- `user_id` - ID пользователя
- `team_id` - ID команды
- `season` - Год сезона (integer, например 2026)
- `goals` - Голы игрока в этом сезоне
- `assists` - Ассисты игрока в этом сезоне
- `matches` - Количество матчей
- Уникальный индекс: `(user_id, season)` - один игрок может быть в одной команде на сезон

### Важно
- **Сезон = календарный год** (не путать с сезонами турниров)
- Один игрок может быть только в одной команде на сезон
- История привязок сохраняется (можно видеть все сезоны игрока)

---

## 2. Трансферное окно

### Период
- **Начало**: 1 июня
- **Конец**: 31 августа

### Правила для обычных пользователей
- Можно сменить команду **1 раз** за трансферное окно
- Вне трансферного окна смена команды невозможна

### Правила для премиум аккаунта
- Можно менять команду **неограниченное количество раз**
- Можно менять команду **вне трансферного окна**

### Исключения
- Новые пользователи без команды могут присоединиться к команде **бесплатно в любое время**

---

## 3. Лимиты команд

### Максимальный состав
- **100 активных игроков** на текущий сезон
- При достижении лимита команда не может принимать новых игроков

### Минимальный состав
- **15 игроков** - минимальный состав команды
- Если в команде менее 15 игроков, покинуть команду **невозможно**

---

## 4. Логика присоединения к команде

### Проверки перед присоединением
1. Есть ли у пользователя текущая команда в текущем сезоне
2. Не превышен ли лимит игроков в команде (100)
3. Открыто ли трансферное окно (для обычных пользователей)
4. Не использовал ли пользователь уже возможность смены команды в этом окне

### Процесс присоединения
1. Если у пользователя уже есть команда в текущем сезоне - удаляется старая привязка
2. Создается новая привязка `user_teams` с текущим сезоном (годом)
3. Обновляется статистика команды

---

## 5. Логика выхода из команды

### Проверки перед выходом
1. Состоит ли пользователь в этой команде
2. Не меньше ли в команде минимального состава (15 игроков)

### Процесс выхода
1. Удаляется привязка `user_teams` для текущего сезона
2. Обновляется статистика команды

---

## 6. Отображение в профиле

### Текущая команда
- Показывается команда игрока в текущем сезоне
- Если команды нет - показывается предложение присоединиться

### История сезонов
- Отображаются все сезоны, в которых игрок состоял в командах
- Для каждого сезона показывается:
  - Команда
  - Год сезона
  - Статистика (голы, ассисты, матчи)

### Статистика товарищеских игр
- Отдельная вкладка в блоке "Персональная статистика по годам"
- Группировка по годам
- Показывает голы, ассисты и матчи из товарищеских игр

---

## 7. Административная панель

### Dashboard
- Отображает соотношение игроков и команд
- Показывает:
  - Общее соотношение (все пользователи)
  - Соотношение для активных игроков (заходили последние 2-3 недели)
  - Заполненность команд (процент от максимума 100 игроков)
  - Уведомления о нехватке/избытке команд
  - Динамику за последние 30 дней

### Страница команд
- Показывает реальное количество игроков в каждой команде
- Сортировка по количеству игроков
- Отображается текущий сезон

---

## 8. Сидеры

### UserTeamsSeeder
- Случайно распределяет игроков по командам для текущего сезона
- Учитывает лимит в 100 игроков на команду
- Оптимизирован для больших объемов данных (batch inserts)

### Запуск
```bash
php artisan db:seed --class=UserTeamsSeeder
```

---

## Технические детали

### Определение текущего сезона
- Текущий сезон = текущий календарный год
- Если сезона нет в БД - создается автоматически
- Используется метод `TeamTransferService::getCurrentSeason()` (возвращает год)

### Миграция
- Миграция `2025_12_20_000003_change_user_teams_season_to_year.php` изменяет структуру:
  - Удаляет `season_id` (foreign key на `tournaments_seasons`)
  - Добавляет `season` (integer, год)
  - Сохраняет существующие данные (конвертирует год из `tournaments_seasons`)

### Сервис TeamTransferService
- Централизует всю логику работы с привязками игроков к командам
- Методы:
  - `canJoinTeam()` - проверка возможности присоединения
  - `joinTeam()` - присоединение к команде
  - `canLeaveTeam()` - проверка возможности выхода
  - `leaveTeam()` - выход из команды
  - `getCurrentSeason()` - получение текущего сезона (года)
  - `getActivePlayersCount()` - количество активных игроков в команде
  - `getTransferRules()` - получение правил трансферного окна

