# Инструкция по запуску и просмотру live матчей

## Быстрый старт

### 1. Подготовка

Убедитесь, что выполнены миграции:
```bash
php artisan migrate
```

### 2. Настройка планировщика (опционально, но рекомендуется)

Для автоматической обработки матчей добавьте в cron:
```bash
* * * * * cd /path-to-project && php artisan schedule:run >> /dev/null 2>&1
```

Или запускайте команду вручную:
```bash
php artisan live-matches:process
```

Эта команда должна выполняться каждую секунду для обновления состояния матчей.

### 3. Запуск матча через админку

1. Войдите в админ-панель
2. Перейдите в раздел **"Матчи"** (`/admin/matches`)
3. Найдите нужный матч в списке
4. Убедитесь, что у матча указаны обе команды (team_1 и team_2)
5. Нажмите кнопку **"Запустить"** (зеленая кнопка с иконкой play)
6. Матч автоматически создастся и начнется

### 4. Просмотр матча

После запуска матча:

1. В списке матчей появится кнопка **"Смотреть"** (зеленая)
2. Нажмите на нее - откроется страница просмотра матча
3. Или перейдите напрямую по ссылке: `/live-matches/{matchId}`

### 5. Что происходит во время матча

- **Длительность**: 15 минут реального времени
- **Обновление**: Страница автоматически обновляется каждую секунду
- **Визуализация**: 
  - Поле с игроками (синие и красные кружки)
  - Счет матча в реальном времени
  - События матча (голы, передачи) с указанием минуты
  - Текущая минута матча

### 6. Завершение матча

Матч автоматически завершится через 15 минут после старта. После завершения:

- Результат автоматически сохранится в основную таблицу `tournaments_matches`
- События (голы, передачи) сохранятся в таблицу `match_events`
- Статистика игроков обновится (голы и передачи)

### 7. Принудительное завершение матча

Если нужно завершить матч досрочно:

1. В списке матчей найдите активный матч
2. Нажмите кнопку **"Завершить"** (желтая кнопка с иконкой stop)
3. Подтвердите действие
4. Результат будет сохранен немедленно

## Структура данных

### Требования для запуска матча

Матч должен иметь:
- `team_1` - ID первой команды
- `team_2` - ID второй команды
- Команды должны иметь игроков в текущем сезоне (таблица `user_teams`)

### Генерация результата

Результат генерируется **заранее** при запуске матча:
- Количество голов: 0-5 для каждой команды (случайно)
- События (голы, передачи) распределяются по 15 минутам матча
- Позиции игроков генерируются случайно с небольшой анимацией

## Технические детали

### Производительность

Система оптимизирована для высокой нагрузки:
- **Redis** для кеширования состояния (если доступен)
- **Кеширование** API endpoint на 1 секунду
- **Polling** вместо WebSockets (проще масштабировать)
- Минимальные запросы к БД

### Обработка ошибок

- Если Redis недоступен, система продолжит работать без кеша
- Если команда не имеет игроков, матч все равно запустится (с пустым составом)
- Ошибки логируются в стандартный лог Laravel

### Мониторинг

Для мониторинга активных матчей:
```sql
SELECT * FROM live_matches WHERE status != 'finished';
```

Для просмотра завершенных матчей:
```sql
SELECT * FROM live_matches WHERE status = 'finished' AND result_saved = 1;
```

## Примеры использования

### Запуск тестового матча

1. Создайте матч в админке:
   - Выберите турнир, сезон, стадию
   - Выберите две команды
   - Сохраните

2. Запустите матч:
   - Нажмите "Запустить" в списке матчей

3. Откройте в нескольких вкладках:
   - `/live-matches/{matchId}`
   - Убедитесь, что все видят одно и то же состояние

### Проверка результата

После завершения матча проверьте:
```sql
-- Основной матч
SELECT score_1, score_2, status FROM tournaments_matches WHERE id = {matchId};

-- События матча
SELECT * FROM match_events WHERE match_id = {matchId};

-- Статистика игроков
SELECT id, name, goals, assists FROM users WHERE id IN (
    SELECT user_id FROM match_events WHERE match_id = {matchId}
);
```

## Устранение неполадок

### Матч не запускается

1. Проверьте, что у матча указаны обе команды
2. Проверьте логи: `storage/logs/laravel.log`
3. Убедитесь, что команды имеют игроков в текущем сезоне

### Матч не обновляется

1. Проверьте, что команда `live-matches:process` выполняется
2. Проверьте Redis (если используется)
3. Откройте консоль браузера для проверки ошибок JavaScript

### Результат не сохраняется

1. Проверьте, что матч завершился (прошло 15 минут)
2. Проверьте логи на наличие ошибок
3. Запустите команду вручную: `php artisan live-matches:process`

## Дополнительная информация

Подробная документация по архитектуре системы находится в файле `docs/live-matches.md`.


