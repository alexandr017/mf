# Система онлайн-трансляции матчей

## Описание

Система позволяет транслировать матчи в реальном времени с поддержкой высокой нагрузки (1000+ одновременных просмотров, до 10 параллельных матчей).

## Архитектура

### Компоненты

1. **Таблица `live_matches`** - временное хранилище состояния матча
   - Хранит результат, события, позиции игроков
   - Результат генерируется заранее, но не сохраняется в основную таблицу до завершения

2. **Redis** - кеширование состояния матча для быстрого доступа
   - Ключ: `live_match:{match_id}`
   - TTL: 60 секунд

3. **MatchResultGenerator** - генерация результата матча заранее
   - Получает ТОП игроков команд
   - Генерирует голы и передачи с временными метками
   - Создает начальные позиции игроков

4. **MatchStateService** - управление состоянием матча
   - Обновление состояния в реальном времени
   - Сохранение результата после завершения
   - Анимация позиций игроков

5. **LiveMatchesController** - контроллер для просмотра матчей
   - Страница матча с визуализацией
   - API endpoint для получения состояния (polling)

6. **ProcessLiveMatches** - команда для обработки матчей
   - Обновляет состояние активных матчей
   - Сохраняет результаты завершенных матчей

## Использование

### Запуск матча

Матч автоматически создается при первом просмотре страницы `/live-matches/{matchId}`.

Для ручного запуска (админ):
```php
POST /live-matches/{matchId}/start
```

### Просмотр матча

1. Откройте `/live-matches/{matchId}`
2. Страница автоматически обновляется каждую секунду
3. Отображается:
   - Счет матча
   - Поле с игроками (Canvas)
   - События матча (голы, передачи)
   - Текущая минута

### Настройка планировщика

Добавьте в `routes/console.php` или через планировщик:

```php
Schedule::command('live-matches:process')->everySecond();
```

Или через cron:
```
* * * * * cd /path-to-project && php artisan live-matches:process >> /dev/null 2>&1
```

## Производительность

### Оптимизации для высокой нагрузки

1. **Кеширование**
   - Redis для состояния матча
   - Кеш на 1 секунду для API endpoint
   - Кеш на 60 секунд в Redis

2. **Polling вместо WebSockets**
   - Проще в реализации
   - Легче масштабировать
   - Меньше нагрузка на сервер

3. **Минимальные запросы к БД**
   - Состояние загружается из Redis
   - Обновление БД только при изменении состояния
   - Batch обработка завершенных матчей

4. **Оптимизация запросов**
   - Eager loading для связей
   - Индексы на важных полях
   - Минимальное количество JOIN'ов

### Рекомендации для продакшена

1. **Redis**
   - Используйте Redis для кеширования
   - Настройте persistence для надежности

2. **CDN**
   - Статические ресурсы через CDN
   - Кеширование JS/CSS

3. **Load Balancer**
   - Распределение нагрузки между серверами
   - Sticky sessions для Redis

4. **Мониторинг**
   - Отслеживание количества подключений
   - Мониторинг производительности Redis
   - Логирование ошибок

## Структура данных

### LiveMatch

```php
{
    "match_id": 1,
    "started_at": "2025-12-18T10:00:00Z",
    "ends_at": "2025-12-18T10:15:00Z",
    "status": "live",
    "score_1": 2,
    "score_2": 1,
    "current_minute": 8,
    "events": [
        {
            "type": "goal",
            "team": 1,
            "minute": 5,
            "scorer_id": 123,
            "scorer_name": "Игрок 1",
            "assister_id": 456,
            "assister_name": "Игрок 2",
            "timestamp": 300
        }
    ],
    "players_positions": {
        "team1": [
            {
                "user_id": 123,
                "name": "Игрок 1",
                "x": 25,
                "y": 50
            }
        ],
        "team2": [...]
    }
}
```

## Безопасность

1. **Валидация данных**
   - Проверка существования матча
   - Проверка прав доступа (если нужно)

2. **Защита от DDoS**
   - Rate limiting для API endpoint
   - Ограничение частоты запросов

3. **Кеширование**
   - Предотвращение повторных запросов
   - Защита от перегрузки БД

## Расширение функциональности

### Добавление новых событий

1. Обновите `MatchResultGenerator::generateEvents()`
2. Добавьте обработку в `MatchStateService::saveMatchResult()`
3. Обновите визуализацию в `show.blade.php`

### Улучшение визуализации

1. Более сложная анимация игроков
2. Добавление мяча на поле
3. Анимация голов
4. Звуковые эффекты

### WebSockets (опционально)

Для еще большей производительности можно использовать:
- Laravel Echo + Pusher
- Laravel WebSockets
- Socket.io

Но polling работает достаточно хорошо для большинства случаев.


