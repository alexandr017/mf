# Товарищеские матчи

## Общая информация

Товарищеские матчи - это автоматически генерируемые матчи между командами, которые проводятся ежедневно. Они позволяют игрокам набирать статистику и улучшать свой рейтинг.

---

## 1. Структура матчей

### Расписание
- **2 матча в день** автоматически
- Участвуют **топ 40 команд** (определяется по рейтингу)
- Команды выбираются случайным образом
- Матчи генерируются на 30 дней вперед

### Статусы матчей
- **scheduled** - Запланирован
- **played** - Сыгран
- **cancelled** - Отменен

---

## 2. Данные матча

### Основная информация
- Команда 1 (хозяева)
- Команда 2 (гости)
- Дата и время матча
- Стадион (берется от команды-хозяев)
- Счет (после матча)

### Детальная статистика (для сыгранных матчей)

#### Голы (scorers)
JSON массив с информацией о бомбардирах:
```json
[
  {
    "user_id": 1,
    "goals": [
      {"minute": 15},
      {"minute": 67}
    ]
  }
]
```

#### Ассисты (assists)
JSON массив с информацией об ассистентах:
```json
[
  {
    "user_id": 2,
    "assists": [
      {"minute": 15},
      {"minute": 67}
    ]
  }
]
```

#### Состав (squad)
JSON объект с заявками команд и временем игры каждого игрока:
```json
{
  "team_1": [
    {
      "user_id": 1,
      "start_minute": 0,
      "end_minute": 30
    }
  ],
  "team_2": [
    {
      "user_id": 5,
      "start_minute": 0,
      "end_minute": 30
    }
  ]
}
```

**Правила состава:**
- В заявке должно быть **33 игрока** (11 на каждые 30 минут матча)
- Все игроки должны поиграть (через замены каждые 30 минут)
- Игроки распределяются по интервалам: 0-30, 30-60, 60-90 минут

---

## 3. Автоматическая обработка

### Cron-задача
- Запускается **ежедневно** (`friendly-matches:process`)
- Обрабатывает все запланированные матчи на текущий день
- Генерирует случайные результаты
- Назначает голы и ассисты топ-игрокам команд
- Создает состав с заменами
- Обновляет статистику игроков (goals, assists)

### Алгоритм обработки
1. Выбираются все матчи со статусом `scheduled` на текущий день
2. Для каждого матча генерируется случайный счет (0-4 для каждой команды)
3. Голы распределяются между топ-игроками команд (приоритет нападающим)
4. Ассисты назначаются случайным образом
5. Создается состав из 33 игроков с интервалами игры
6. Обновляется статистика игроков в таблице `users`

---

## 4. Отображение на сайте

### Страница товарищеских матчей (`/friendly-matches`)
- Разбивка по дням
- Фильтрация по дате (календарь)
- Фильтрация по статусу (сыгранные/несыгранные)
- Три вкладки:
  - **Прошедшие** - все матчи позднее вчера (от менее давних к более давним)
  - **Вчера, сегодня, завтра** - матчи за эти дни
  - **Будущие** - матчи начиная с послезавтра (от более поздних к менее поздним)
- При использовании фильтров вкладки скрываются

### Страница деталей матча (`/friendly-matches/{id}`)
- Полная информация о матче
- Список голов с минутами
- Список ассистов с минутами
- Состав команд с временем игры каждого игрока

### Блок на главной странице и странице турниров
- Показывает последние товарищеские матчи
- Карточка матча кликабельна и ведет на страницу деталей
- Используется единый модуль `match-card` для всех типов матчей

---

## 5. Административная панель

### CRUD операции
- Создание матчей
- Редактирование матчей
- Удаление матчей
- Просмотр деталей сыгранных матчей

### Особенности
- Использование `select2` для выбора команд
- Кнопка просмотра ведет на клиентскую страницу деталей
- Отображение детальной статистики (голы, ассисты, состав) для сыгранных матчей

---

## 6. Статистика игроков

### Учет в профиле
- Голы и ассисты из товарищеских матчей учитываются в общей статистике игрока
- Отдельная вкладка "Товарищеские игры" в блоке "Персональная статистика по годам"
- Статистика группируется по годам

### Начисление рейтинга
- Голы и ассисты автоматически обновляют статистику игрока
- Влияют на общий рейтинг через систему рейтинга команд

---

## 7. Сидеры

### FriendlyMatchesSeeder
- Создает 2 матча в день на 30 дней вперед
- Использует топ 40 команд
- Первые 10 матчей помечаются как сыгранные с детальной статистикой
- Генерирует голы, ассисты и состав для сыгранных матчей

### Запуск
```bash
php artisan db:seed --class=FriendlyMatchesSeeder
```

---

## Технические детали

### Таблица `friendly_matches`
- `team_1`, `team_2` - ID команд
- `date` - Дата и время матча
- `score_1`, `score_2` - Счет
- `status` - Статус матча
- `scorers` - JSON с голами и минутами
- `assists` - JSON с ассистами и минутами
- `squad` - JSON с составом и временем игры

### Модель `FriendlyMatch`
- Связи: `homeTeam()`, `awayTeam()`
- Методы: `isPlayed()`, `isScheduled()`, `isCancelled()`

### Команда обработки
- `app/Console/Commands/ProcessFriendlyMatches.php`
- Запускается через `Schedule::command('friendly-matches:process')->daily()`

